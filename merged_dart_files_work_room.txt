
// ===== FILE: ./lib/features/work_room/work_room_list_controller.dart =====

import 'package:get/get.dart';
import 'package:legalfactfinder2025/features/authentication/auth_controller.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_model.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_repository.dart';

class WorkRoomListController extends GetxController {
  final WorkRoomRepository repository = WorkRoomRepository();

  RxList<WorkRoom> workRooms = <WorkRoom>[].obs;
  RxBool isLoading = false.obs;
  RxString errorMessage = ''.obs;

  /// íŠ¹ì • ì‚¬ìš©ìì˜ WorkRoom ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
  Future<void> fetchWorkRooms() async {
    AuthController authController= Get.find<AuthController>();
    String? userId = authController.getUserId();

    if(userId == null){
      print("User ID is null");
      return;
    }

    try {
      isLoading.value = true;
      errorMessage.value = '';

      // Fetch work rooms from the repository
      final fetchedWorkRooms = await repository.getWorkRoomsByUserId(userId);

      // Check if the fetched work rooms are null and handle it
      if (fetchedWorkRooms == null) {
        errorMessage.value = "No work rooms found for this user.";
      } else {
        workRooms.assignAll(fetchedWorkRooms);
      }
    } catch (e) {
      errorMessage.value = "Failed to load Work Rooms: $e";
    } finally {
      isLoading.value = false;
    }
  }
}


// ===== FILE: ./lib/features/work_room/work_room_request_controller.dart =====

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_request_repository.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_request_model.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class WorkRoomRequestController extends GetxController {
  final WorkRoomRequestRepository repository = WorkRoomRequestRepository(Supabase.instance.client);

  var isLoading = false.obs;
  var successMessage = ''.obs;
  var errorMessage = ''.obs;
  var receivedRequests = <WorkRoomRequest>[].obs;
  var sentRequests = <WorkRoomRequest>[].obs;

  // âœ… WorkRoom ì´ˆëŒ€ ìš”ì²­ ë³´ë‚´ê¸°
  Future<void> sendWorkRoomRequest(String requesterId, String recipientEmail, String workRoomId) async {
    try {
      final startTime = DateTime.now();
      debugPrint("ğŸ”„ [WorkRoomRequestController] Sending WorkRoom request from '$requesterId' to '$recipientEmail' for WorkRoom '$workRoomId' at $startTime");

      isLoading(true);
      successMessage('');
      errorMessage('');

      debugPrint("â³ [WorkRoomRequestController] Calling repository.sendWorkRoomRequest...");
      final success = await repository.sendWorkRoomRequest(requesterId, recipientEmail, workRoomId);

      final endTime = DateTime.now();
      final duration = endTime.difference(startTime);
      debugPrint("âœ… [WorkRoomRequestController] API call completed in \${duration.inMilliseconds}ms");

      if (success) {
        successMessage('WorkRoom request sent successfully.');
        debugPrint("ğŸ“¨ [WorkRoomRequestController] WorkRoom request successfully sent to $recipientEmail");

        fetchSentRequests(requesterId); // âœ… ë³´ë‚¸ ìš”ì²­ ì¦‰ì‹œ ê°±ì‹ 
      } else {
        errorMessage('Failed to send WorkRoom request. User may not exist.');
        debugPrint("âŒ [WorkRoomRequestController] WorkRoom request failed: User not found or another issue.");
      }
    } catch (e, stacktrace) {
      errorMessage('Error sending WorkRoom request.');
      debugPrint("âŒ [WorkRoomRequestController] Exception occurred while sending WorkRoom request: $e");
      debugPrint("ğŸ” [WorkRoomRequestController] Stacktrace: $stacktrace");
    } finally {
      isLoading(false);
      debugPrint("ğŸ”„ [WorkRoomRequestController] Finished processing WorkRoom request.");
    }
  }

  // âœ… ë°›ì€ WorkRoom ì´ˆëŒ€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  Future<void> fetchReceivedRequests(String userId) async {
    try {
      debugPrint("ğŸ”„ [WorkRoomRequestController] Fetching received work room requests for user: $userId");

      isLoading(true);
      errorMessage('');

      List<WorkRoomRequest> requests = await repository.getReceivedRequests(userId);
      receivedRequests.assignAll(requests);

      debugPrint("âœ… [WorkRoomRequestController] Successfully fetched received work room requests.");
    } catch (e, stacktrace) {
      errorMessage('âŒ Error fetching received work room requests');
      debugPrint("âŒ Exception: $e");
      debugPrint("ğŸ” Stacktrace: $stacktrace");
    } finally {
      isLoading(false);
    }
  }

  // âœ… ë³´ë‚¸ WorkRoom ì´ˆëŒ€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  Future<void> fetchSentRequests(String userId) async {
    try {
      debugPrint("ğŸ”„ [WorkRoomRequestController] Fetching sent work room requests for user: $userId");

      isLoading(true);
      errorMessage('');

      List<WorkRoomRequest> requests = await repository.getSentRequests(userId);
      sentRequests.assignAll(requests);

      debugPrint("âœ… [WorkRoomRequestController] Successfully fetched sent work room requests.");
    } catch (e, stacktrace) {
      errorMessage('âŒ Error fetching sent work room requests');
      debugPrint("âŒ Exception: $e");
      debugPrint("ğŸ” Stacktrace: $stacktrace");
    } finally {
      isLoading(false);
    }
  }
  // âœ… WorkRoom ì´ˆëŒ€ ìˆ˜ë½/ê±°ì ˆ
  Future<void> handleWorkRoomRequest(String requestId,  String action) async {
    try {
      isLoading(true);
      successMessage('');
      errorMessage('');

      debugPrint("â³ [WorkRoomRequestController] Processing WorkRoom request: \$requestId with action: \$action");
      final success = await repository.answerWorkRoomRequest(requestId,  action);

      if (success) {
        successMessage('WorkRoom request \$action successfully.');
        debugPrint("âœ… [WorkRoomRequestController] WorkRoom request \$action successfully.");
      } else {
        errorMessage('Failed to process WorkRoom request.');
        debugPrint("âŒ [WorkRoomRequestController] WorkRoom request processing failed.");
      }
    } catch (e, stacktrace) {
      errorMessage('Error processing WorkRoom request.');
      debugPrint("âŒ [WorkRoomRequestController] Exception: \$e");
      debugPrint("ğŸ” [WorkRoomRequestController] Stacktrace: \$stacktrace");
    } finally {
      isLoading(false);
      debugPrint("ğŸ”„ [WorkRoomRequestController] Finished processing WorkRoom request.");
    }
  }
}


// ===== FILE: ./lib/features/work_room/work_room_details_controller.dart =====

import 'package:get/get.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_details_model.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_details_repository.dart';

class WorkRoomDetailsController extends GetxController {

  final WorkRoomDetailsRepository workRoomDetailsRepository = WorkRoomDetailsRepository();

  Rx<WorkRoomDetails?> workRoomDetails = Rx<WorkRoomDetails?>(null);

  // ìƒíƒœ ë³€ìˆ˜
  var workRoom = Rxn<WorkRoom>(); // Rxn: nullì„ í—ˆìš©í•˜ëŠ” ë°˜ì‘í˜• ë³€ìˆ˜
  var isLoading = false.obs; // ë¡œë”© ìƒíƒœ
  var errorMessage = ''.obs; // ì—ëŸ¬ ë©”ì‹œì§€
  var successMessage = ''.obs; // ì„±ê³µ ë©”ì‹œì§€


  Future<void> fetchWorkRoomDetails(String workRoomId) async {
    try {
      isLoading.value = true;
      errorMessage.value = '';

      final details = await workRoomDetailsRepository.getWorkRoomDetails(workRoomId);
      workRoomDetails.value = details;
    } catch (e) {
      errorMessage.value = "Failed to load WorkRoom details: $e";
    } finally {
      isLoading.value = false;
    }
  }


}


// ===== FILE: ./lib/features/work_room/data/work_room_request_model.dart =====

import 'package:json_annotation/json_annotation.dart';

part 'work_room_request_model.g.dart';

@JsonSerializable()
class WorkRoomRequest {
  final String id;
  final String requesterId;
  final String? recipientId;
  final String workRoomId;
  final String? recipientEmail;
  final String status;
  final DateTime sentAt;
  final DateTime? respondedAt;

  WorkRoomRequest({
    required this.id,
    required this.requesterId,
    this.recipientId,
    required this.workRoomId,
    this.recipientEmail,
    required this.status,
    required this.sentAt,
    this.respondedAt,
  });

  factory WorkRoomRequest.fromJson(Map<String, dynamic> json) {
    return WorkRoomRequest(
      id: json['id'] as String? ?? '',
      requesterId: json['requester_id'] as String? ?? '',
      recipientId: json['recipient_id'] as String?,
      workRoomId: json['work_room_id'] as String? ?? '',
      recipientEmail: json['recipient_email'] as String?,
      status: json['status'] as String? ?? 'pending',
      sentAt: DateTime.tryParse(json['sent_at'] as String? ?? '') ?? DateTime.now(),
      respondedAt: json['responded_at'] != null ? DateTime.tryParse(json['responded_at'] as String) : null,
    );
  }

  Map<String, dynamic> toJson() => _$WorkRoomRequestToJson(this);
}


// ===== FILE: ./lib/features/work_room/data/work_room_details_model.dart =====

import 'package:json_annotation/json_annotation.dart';

part 'work_room_details_model.g.dart';

@JsonSerializable()
class WorkRoom {
  final String id;
  final String title; // ìˆ˜ì •: name -> title
  final String description;
  final DateTime createdAt;
  final DateTime updatedAt;

  WorkRoom({
    required this.id,
    required this.title,
    required this.description,
    required this.createdAt,
    required this.updatedAt,
  });

  factory WorkRoom.fromJson(Map<String, dynamic> json) {
    return WorkRoom(
      id: json['id'] as String? ?? '',
      title: json['title'] as String? ?? '', // ìˆ˜ì •ëœ ì»¬ëŸ¼ëª… ë°˜ì˜
      description: json['description'] as String? ?? '',
      createdAt: DateTime.tryParse(json['created_at'] as String? ?? '') ?? DateTime.now(),
      updatedAt: DateTime.tryParse(json['updated_at'] as String? ?? '') ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toJson() => _$WorkRoomToJson(this);
}

@JsonSerializable()
class WorkRoomParticipant {
  final String id;
  final String workRoomId; // ìˆ˜ì •: work_room_id ì¶”ê°€
  final String userId;
  final bool isAdmin;
  final DateTime joinedAt;
  final DateTime lastSeen;

  WorkRoomParticipant({
    required this.id,
    required this.workRoomId, // ì¶”ê°€ëœ í•„ë“œ
    required this.userId,
    required this.isAdmin,
    required this.joinedAt,
    required this.lastSeen,
  });

  factory WorkRoomParticipant.fromJson(Map<String, dynamic> json) {
    return WorkRoomParticipant(
      id: json['id'] as String? ?? '',
      workRoomId: json['work_room_id'] as String? ?? '', // ì¶”ê°€
      userId: json['user_id'] as String? ?? '',
      isAdmin: json['is_admin'] as bool? ?? false,
      joinedAt: DateTime.tryParse(json['joined_at'] as String? ?? '') ?? DateTime.now(),
      lastSeen: DateTime.tryParse(json['last_seen'] as String? ?? '') ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toJson() => _$WorkRoomParticipantToJson(this);
}

@JsonSerializable()
class WorkRoomParty {
  final String id;
  final String workRoomId;
  final String name;
  final String role;
  final DateTime createdAt;
  final DateTime updatedAt;

  WorkRoomParty({
    required this.id,
    required this.workRoomId,
    required this.name,
    required this.role,
    required this.createdAt,
    required this.updatedAt,
  });

  factory WorkRoomParty.fromJson(Map<String, dynamic> json) {
    return WorkRoomParty(
      id: json['id'] as String? ?? '',
      workRoomId: json['work_room_id'] as String? ?? '',
      name: json['name'] as String? ?? '',
      role: json['role'] as String? ?? '',
      createdAt: DateTime.tryParse(json['created_at'] as String? ?? '') ?? DateTime.now(),
      updatedAt: DateTime.tryParse(json['updated_at'] as String? ?? '') ?? DateTime.now(),
    );
  }

  Map<String, dynamic> toJson() => _$WorkRoomPartyToJson(this);
}

@JsonSerializable()
class WorkRoomDetails {
  final WorkRoom workRoom;
  final List<WorkRoomParticipant> participants;
  final List<WorkRoomParty> parties;

  WorkRoomDetails({
    required this.workRoom,
    required this.participants,
    required this.parties,
  });

  factory WorkRoomDetails.fromJson(Map<String, dynamic> json) {
    return WorkRoomDetails(
      workRoom: WorkRoom.fromJson(json['work_room'] as Map<String, dynamic>? ?? {}),
      participants: (json['participants'] as List<dynamic>?)
          ?.map((participant) => WorkRoomParticipant.fromJson(participant))
          .toList() ??
          [],
      parties: (json['parties'] as List<dynamic>?)
          ?.map((party) => WorkRoomParty.fromJson(party))
          .toList() ??
          [],
    );
  }

  Map<String, dynamic> toJson() => _$WorkRoomDetailsToJson(this);
}


// ===== FILE: ./lib/features/work_room/data/work_room_model.g.dart =====

// GENERATED CODE - DO NOT MODIFY BY HAND

part of 'work_room_model.dart';

// **************************************************************************
// JsonSerializableGenerator
// **************************************************************************

WorkRoom _$WorkRoomFromJson(Map<String, dynamic> json) => WorkRoom(
      id: json['id'] as String,
      title: json['title'] as String,
      description: json['description'] as String,
      createdAt: DateTime.parse(json['createdAt'] as String),
      updatedAt: DateTime.parse(json['updatedAt'] as String),
      participants: (json['participants'] as List<dynamic>)
          .map((e) => Participant.fromJson(e as Map<String, dynamic>))
          .toList(),
    );

Map<String, dynamic> _$WorkRoomToJson(WorkRoom instance) => <String, dynamic>{
      'id': instance.id,
      'title': instance.title,
      'description': instance.description,
      'createdAt': instance.createdAt.toIso8601String(),
      'updatedAt': instance.updatedAt.toIso8601String(),
      'participants': instance.participants,
    };

Participant _$ParticipantFromJson(Map<String, dynamic> json) => Participant(
      userId: json['userId'] as String,
      isAdmin: json['isAdmin'] as bool,
      username: json['username'] as String,
      profilePictureUrl: json['profilePictureUrl'] as String,
      isLawyer: json['isLawyer'] as bool,
    );

Map<String, dynamic> _$ParticipantToJson(Participant instance) =>
    <String, dynamic>{
      'userId': instance.userId,
      'isAdmin': instance.isAdmin,
      'username': instance.username,
      'profilePictureUrl': instance.profilePictureUrl,
      'isLawyer': instance.isLawyer,
    };


// ===== FILE: ./lib/features/work_room/data/work_room_request_model.g.dart =====

// GENERATED CODE - DO NOT MODIFY BY HAND

part of 'work_room_request_model.dart';

// **************************************************************************
// JsonSerializableGenerator
// **************************************************************************

WorkRoomRequest _$WorkRoomRequestFromJson(Map<String, dynamic> json) =>
    WorkRoomRequest(
      id: json['id'] as String,
      requesterId: json['requesterId'] as String,
      recipientId: json['recipientId'] as String?,
      workRoomId: json['workRoomId'] as String,
      recipientEmail: json['recipientEmail'] as String?,
      status: json['status'] as String,
      sentAt: DateTime.parse(json['sentAt'] as String),
      respondedAt: json['respondedAt'] == null
          ? null
          : DateTime.parse(json['respondedAt'] as String),
    );

Map<String, dynamic> _$WorkRoomRequestToJson(WorkRoomRequest instance) =>
    <String, dynamic>{
      'id': instance.id,
      'requesterId': instance.requesterId,
      'recipientId': instance.recipientId,
      'workRoomId': instance.workRoomId,
      'recipientEmail': instance.recipientEmail,
      'status': instance.status,
      'sentAt': instance.sentAt.toIso8601String(),
      'respondedAt': instance.respondedAt?.toIso8601String(),
    };


// ===== FILE: ./lib/features/work_room/data/work_room_model.dart =====

import 'package:json_annotation/json_annotation.dart';

part 'work_room_model.g.dart';

@JsonSerializable()
class WorkRoom {
  final String id; // "id" ì»¬ëŸ¼
  final String title; // "title" ì»¬ëŸ¼
  final String description; // "description" ì»¬ëŸ¼
  final DateTime createdAt; // "created_at" ì»¬ëŸ¼
  final DateTime updatedAt; // "updated_at" ì»¬ëŸ¼
  final List<Participant> participants;

  WorkRoom({
    required this.id,
    required this.title,
    required this.description,
    required this.createdAt,
    required this.updatedAt,
    required this.participants,
  });

  // Null-safe factory method for JSON deserialization
  factory WorkRoom.fromJson(Map<String, dynamic> json) {
    return WorkRoom(
      id: json['work_room_id'] as String? ?? '',
      title: json['title'] as String? ?? '',
      description: json['description'] as String? ?? '',
      createdAt: DateTime.tryParse(json['created_at'] as String? ?? '') ?? DateTime.now(),
      updatedAt: DateTime.tryParse(json['updated_at'] as String? ?? '') ?? DateTime.now(),
      participants: (json['participants'] as List<dynamic>?)
          ?.map((participantJson) => Participant.fromJson(participantJson))
          .toList() ??
          [],
    );
  }

  Map<String, dynamic> toJson() => _$WorkRoomToJson(this);
}

@JsonSerializable()
class Participant {
  final String userId;
  final bool isAdmin;
  final String username;
  final String profilePictureUrl;
  final bool isLawyer;

  Participant({
    required this.userId,
    required this.isAdmin,
    required this.username,
    required this.profilePictureUrl,
    required this.isLawyer,
  });

  factory Participant.fromJson(Map<String, dynamic> json) {
    return Participant(
      userId: json['user_id'] as String? ?? '',
      isAdmin: json['is_admin'] as bool? ?? false,

      username: json['username'] as String? ?? '',
      profilePictureUrl: json['profile_picture_url'] as String? ?? '',
      isLawyer: json['is_lawyer'] as bool? ?? false,
    );
  }

  Map<String, dynamic> toJson() => _$ParticipantToJson(this);
}


// ===== FILE: ./lib/features/work_room/data/work_room_details_model.g.dart =====

// GENERATED CODE - DO NOT MODIFY BY HAND

part of 'work_room_details_model.dart';

// **************************************************************************
// JsonSerializableGenerator
// **************************************************************************

WorkRoom _$WorkRoomFromJson(Map<String, dynamic> json) => WorkRoom(
      id: json['id'] as String,
      title: json['title'] as String,
      description: json['description'] as String,
      createdAt: DateTime.parse(json['createdAt'] as String),
      updatedAt: DateTime.parse(json['updatedAt'] as String),
    );

Map<String, dynamic> _$WorkRoomToJson(WorkRoom instance) => <String, dynamic>{
      'id': instance.id,
      'title': instance.title,
      'description': instance.description,
      'createdAt': instance.createdAt.toIso8601String(),
      'updatedAt': instance.updatedAt.toIso8601String(),
    };

WorkRoomParticipant _$WorkRoomParticipantFromJson(Map<String, dynamic> json) =>
    WorkRoomParticipant(
      id: json['id'] as String,
      workRoomId: json['workRoomId'] as String,
      userId: json['userId'] as String,
      isAdmin: json['isAdmin'] as bool,
      joinedAt: DateTime.parse(json['joinedAt'] as String),
      lastSeen: DateTime.parse(json['lastSeen'] as String),
    );

Map<String, dynamic> _$WorkRoomParticipantToJson(
        WorkRoomParticipant instance) =>
    <String, dynamic>{
      'id': instance.id,
      'workRoomId': instance.workRoomId,
      'userId': instance.userId,
      'isAdmin': instance.isAdmin,
      'joinedAt': instance.joinedAt.toIso8601String(),
      'lastSeen': instance.lastSeen.toIso8601String(),
    };

WorkRoomParty _$WorkRoomPartyFromJson(Map<String, dynamic> json) =>
    WorkRoomParty(
      id: json['id'] as String,
      workRoomId: json['workRoomId'] as String,
      name: json['name'] as String,
      role: json['role'] as String,
      createdAt: DateTime.parse(json['createdAt'] as String),
      updatedAt: DateTime.parse(json['updatedAt'] as String),
    );

Map<String, dynamic> _$WorkRoomPartyToJson(WorkRoomParty instance) =>
    <String, dynamic>{
      'id': instance.id,
      'workRoomId': instance.workRoomId,
      'name': instance.name,
      'role': instance.role,
      'createdAt': instance.createdAt.toIso8601String(),
      'updatedAt': instance.updatedAt.toIso8601String(),
    };

WorkRoomDetails _$WorkRoomDetailsFromJson(Map<String, dynamic> json) =>
    WorkRoomDetails(
      workRoom: WorkRoom.fromJson(json['workRoom'] as Map<String, dynamic>),
      participants: (json['participants'] as List<dynamic>)
          .map((e) => WorkRoomParticipant.fromJson(e as Map<String, dynamic>))
          .toList(),
      parties: (json['parties'] as List<dynamic>)
          .map((e) => WorkRoomParty.fromJson(e as Map<String, dynamic>))
          .toList(),
    );

Map<String, dynamic> _$WorkRoomDetailsToJson(WorkRoomDetails instance) =>
    <String, dynamic>{
      'workRoom': instance.workRoom,
      'participants': instance.participants,
      'parties': instance.parties,
    };


// ===== FILE: ./lib/features/work_room/data/work_room_details_repository.dart =====

import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:legalfactfinder2025/constants.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_details_model.dart';

class WorkRoomDetailsRepository {
  Future<WorkRoomDetails> getWorkRoomDetails(String workRoomId) async {
    final url = Uri.parse('$baseUrl/functions/v1/get_work_room_details_json');

    print("ğŸ”µ [REQUEST] Fetching WorkRoom details for ID: $workRoomId from $url");

    try {
      final response = await http.post(
        url,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $jwtToken',
        },
        body: jsonEncode({'work_room_id': workRoomId}),
      );

      print("ğŸŸ¢ [RESPONSE] Status Code: ${response.statusCode}");
      print("ğŸŸ¢ Raw Body: ${response.body}");

      if (response.statusCode == 200) {
        final decodedResponse = utf8.decode(response.bodyBytes);
        final responseData = jsonDecode(decodedResponse);

        print("ğŸ”¹ Parsed JSON: $responseData");

        if (responseData is! Map<String, dynamic> || !responseData.containsKey('work_room_details')) {
          throw Exception("Unexpected response format: Missing 'work_room_details' key.");
        }

        final workRoomDetails = WorkRoomDetails.fromJson(responseData['work_room_details']);

        print("âœ… Successfully fetched WorkRoom details!");
        return workRoomDetails;
      } else {
        print("âŒ [ERROR] Failed to fetch WorkRoom details: ${response.body}");
        throw Exception("Failed to fetch WorkRoom details: ${response.body}");
      }
    } catch (e, stackTrace) {
      print("ğŸš¨ [EXCEPTION] Error fetching WorkRoom details");
      print("ğŸ”´ Exception: $e");
      print("ğŸ”´ Stack Trace: $stackTrace");
      throw Exception("An unexpected error occurred: $e");
    }
  }
}


// ===== FILE: ./lib/features/work_room/data/work_room_request_repository.dart =====

import 'dart:convert';

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:legalfactfinder2025/features/authentication/auth_controller.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_request_model.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class WorkRoomRequestRepository {
  final SupabaseClient supabase;

  WorkRoomRequestRepository(this.supabase);

  // âœ… Supabase Edge Function `put_work_room_request` í˜¸ì¶œí•˜ì—¬ WorkRoom ìš”ì²­ ì²˜ë¦¬
  Future<bool> sendWorkRoomRequest(String requesterId, String recipientEmail, String workRoomId) async {
    try {
      debugPrint("ğŸ”„ [WorkRoomRequestRepository] Sending WorkRoom request from '$requesterId' to '$recipientEmail' for WorkRoom '$workRoomId'");

      final startTime = DateTime.now();
      debugPrint("â³ [WorkRoomRequestRepository] Invoking Supabase Edge Function...");

      final responseEdge = await supabase.functions.invoke(
        'put_work_room_request',
        body: {
          'requester_id': requesterId,
          'recipient_email': recipientEmail,
          'work_room_id': workRoomId,
        },
      );

      final endTime = DateTime.now();
      final duration = endTime.difference(startTime);
      debugPrint("âœ… [WorkRoomRequestRepository] Edge Function completed in \${duration.inMilliseconds}ms");

      if (responseEdge.data == null) {
        debugPrint("âŒ [WorkRoomRequestRepository] No data received from Edge Function.");
        return false;
      }

      debugPrint("âœ… [WorkRoomRequestRepository] WorkRoom request successfully sent via Edge Function.");
      return true;
    } catch (e, stacktrace) {
      debugPrint("âŒ [WorkRoomRequestRepository] Error sending WorkRoom request: $e");
      debugPrint("ğŸ” [WorkRoomRequestRepository] Stacktrace: $stacktrace");
      return false;
    }
  }

  // âœ… ë°›ì€ WorkRoom ì´ˆëŒ€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  Future<List<WorkRoomRequest>> getReceivedRequests(String userId) async {
    try {
      debugPrint("ğŸ”„ [WorkRoomRequestRepository] Fetching received work room requests for user: $userId");

      final response = await supabase.functions.invoke(
        'get_received_work_room_requests',
        body: {'user_id': userId},
      );

      if (response.data == null) {
        debugPrint("âŒ [WorkRoomRequestRepository] No data received.");
        return [];
      }

      List<dynamic> responseData;
      if (response.data is String) {
        responseData = jsonDecode(response.data);
      } else if (response.data is List) {
        responseData = response.data;
      } else {
        throw Exception("Unexpected response format: \${response.data}");
      }

      debugPrint("âœ… [WorkRoomRequestRepository] Successfully fetched received work room requests.");
      return responseData.map((e) => WorkRoomRequest.fromJson(e as Map<String, dynamic>)).toList();
    } catch (e) {
      debugPrint("âŒ [WorkRoomRequestRepository] Error fetching received requests: $e");
      return [];
    }
  }

  // âœ… ë³´ë‚¸ WorkRoom ì´ˆëŒ€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  Future<List<WorkRoomRequest>> getSentRequests(String userId) async {
    try {
      debugPrint("ğŸ”„ [WorkRoomRequestRepository] Fetching sent work room requests for user: $userId");

      final response = await supabase.functions.invoke(
        'get_sent_work_room_requests',
        body: {'user_id': userId},
      );

      if (response.data == null) {
        debugPrint("âŒ [WorkRoomRequestRepository] No data received.");
        return [];
      }

      List<dynamic> responseData;
      if (response.data is String) {
        responseData = jsonDecode(response.data);
      } else if (response.data is List) {
        responseData = response.data;
      } else {
        throw Exception("Unexpected response format: \${response.data}");
      }

      debugPrint("âœ… [WorkRoomRequestRepository] Successfully fetched sent work room requests.");
      return responseData.map((e) => WorkRoomRequest.fromJson(e as Map<String, dynamic>)).toList();
    } catch (e) {
      debugPrint("âŒ [WorkRoomRequestRepository] Error fetching sent requests: $e");
      return [];
    }
  }

  // âœ… WorkRoom ì´ˆëŒ€ ìˆ˜ë½/ê±°ì ˆ ì²˜ë¦¬
  Future<bool> answerWorkRoomRequest(String requestId,  String action) async {
    AuthController authController = Get.find<AuthController>();
    String? myUserId = authController.getUserId();

    if(myUserId==null){
        throw Exception("User ID is null. Cannot proceed with answering WorkRoom request.");
    }
    try {
      debugPrint("ğŸ”„ [WorkRoomRequestRepository] Answering WorkRoom request: \$requestId with action: \$action");

      final responseEdge = await supabase.functions.invoke(
        'answer_work_room_request',
        body: {
          'request_id': requestId,
          'recipient_id': myUserId,
          'action': action,
        },
      );

      if (responseEdge.data == null) {
        debugPrint("âŒ [WorkRoomRequestRepository] No data received from Edge Function.");
        return false;
      }

      debugPrint("âœ… [WorkRoomRequestRepository] WorkRoom request successfully answered.");
      return true;
    } catch (e, stacktrace) {
      debugPrint("âŒ [WorkRoomRequestRepository] Error answering WorkRoom request: \$e");
      debugPrint("ğŸ” [WorkRoomRequestRepository] Stacktrace: \$stacktrace");
      return false;
    }
  }
}

// ===== FILE: ./lib/features/work_room/data/work_room_repository.dart =====

import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:legalfactfinder2025/constants.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_model.dart';

class WorkRoomRepository {

  Future<List<WorkRoom>> getWorkRoomsByUserId(String userId) async {
    final url = Uri.parse('$baseUrl/functions/v1/get_work_rooms_by_user_id');

    print("ğŸ”µ [REQUEST] Fetching WorkRooms for userId: $userId from $url");

    try {
      final response = await http.post(
        url,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $jwtToken',
        },
        body: jsonEncode({'p_user_id': userId}),
      );

      print("ğŸŸ¢ [RESPONSE] Status Code: ${response.statusCode}");
      print("ğŸŸ¢ Raw Body: ${response.body}");

      if (response.statusCode == 200) {
        final decodedResponse = utf8.decode(response.bodyBytes);
        final responseData = jsonDecode(decodedResponse);

        print("ğŸ”¹ Parsed JSON: $responseData");

        // Check if 'work_rooms' is null or absent
        if (responseData is! Map<String, dynamic> || responseData['work_rooms'] == null) {
          print("ğŸ”´ No work rooms found or 'work_rooms' key is null.");
          return []; // Return an empty list if no work rooms are found
        }

        final workRooms = (responseData['work_rooms'] as List<dynamic>)
            .map((json) => WorkRoom.fromJson(json))
            .toList();

        print("âœ… Successfully fetched ${workRooms.length} WorkRooms!");
        return workRooms;
      } else {
        print("âŒ [ERROR] Failed to fetch WorkRooms: ${response.body}");
        throw Exception("Failed to fetch WorkRooms: ${response.body}");
      }
    } catch (e, stackTrace) {
      print("ğŸš¨ [EXCEPTION] Error fetching WorkRooms");
      print("ğŸ”´ Exception: $e");
      print("ğŸ”´ Stack Trace: $stackTrace");
      throw Exception("An unexpected error occurred: $e");
    }
  }



  Future<WorkRoom> getWorkRoomById(String workRoomId) async {
    final url = Uri.parse('$baseUrl/functions/v1/get_work_room_with_participants_json');

    print("ğŸ”µ [REQUEST] Fetching WorkRoom details for ID: $workRoomId from $url");

    try {
      final response = await http.post(
        url,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $jwtToken',
        },
        body: jsonEncode({'p_work_room_id': workRoomId}),
      );

      print("ğŸŸ¢ [RESPONSE] Status Code: ${response.statusCode}");
      print("ğŸŸ¢ Raw Body: ${response.body}");

      if (response.statusCode == 200) {
        final decodedResponse = utf8.decode(response.bodyBytes);
        final responseData = jsonDecode(decodedResponse);

        print("ğŸ”¹ Parsed JSON: $responseData");

        // Check for `work_room_with_participants` key
        if (responseData is! Map<String, dynamic> || !responseData.containsKey('work_room_with_participants')) {
          throw Exception("Unexpected response format: Missing 'work_room_with_participants' key.");
        }

        final workRoomWithParticipants = responseData['work_room_with_participants'];

        // Extract and parse `work_room`
        if (!workRoomWithParticipants.containsKey('work_room')) {
          throw Exception("Unexpected response format: Missing 'work_room' key.");
        }

        final workRoom = WorkRoom.fromJson(workRoomWithParticipants['work_room']);

        print("âœ… Successfully fetched WorkRoom details!");
        return workRoom;
      } else {
        print("âŒ [ERROR] Failed to fetch WorkRoom details: ${response.body}");
        throw Exception("Failed to fetch WorkRoom details: ${response.body}");
      }
    } catch (e, stackTrace) {
      print("ğŸš¨ [EXCEPTION] Error fetching WorkRoom details");
      print("ğŸ”´ Exception: $e");
      print("ğŸ”´ Stack Trace: $stackTrace");
      throw Exception("An unexpected error occurred: $e");
    }
  }



  // WorkRoom ìƒì„±
  Future<void> createWorkRoom(String title, String description, String userId) async {
    final response = await http.post(
      Uri.parse('$baseUrl/functions/v1/put_work_room'), // constants.dartì—ì„œ URL ì‚¬ìš©
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer $jwtToken', // constants.dartì—ì„œ JWT Token ì‚¬ìš©
      },
      body: jsonEncode({
        'title': title,
        'description': description,
        'user_id': userId,
      }),
    );

    if (response.statusCode != 200) {
      throw Exception('Failed to create WorkRoom: ${response.body}');
    }
  }
}


// ===== FILE: ./lib/features/work_room/domain/send_invitation_usecase.dart =====



// ===== FILE: ./lib/features/work_room/domain/accept_invitation_usecase.dart =====



// ===== FILE: ./lib/features/work_room/domain/fetch_work_rooms_usecase.dart =====



// ===== FILE: ./lib/features/work_room/presentation/add_work_room_page.dart =====

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:legalfactfinder2025/features/authentication/auth_controller.dart';
import 'package:legalfactfinder2025/features/work_room/work_room_controller.dart';
import 'package:legalfactfinder2025/features/work_room/work_room_list_controller.dart';

class AddWorkRoomPage extends StatefulWidget {
  const AddWorkRoomPage({super.key});

  @override
  _AddWorkRoomPageState createState() => _AddWorkRoomPageState();
}

class _AddWorkRoomPageState extends State<AddWorkRoomPage> {
  final _formKey = GlobalKey<FormState>();
  final TextEditingController _titleController = TextEditingController();
  final TextEditingController _descriptionController = TextEditingController();

  late AuthController authController;
  late WorkRoomController workRoomController;
  String? userId;

  @override
  void initState() {
    super.initState();

    // GetX ì»¨íŠ¸ë¡¤ëŸ¬ ê°€ì ¸ì˜¤ê¸°
    authController = Get.find<AuthController>();
    workRoomController = Get.find<WorkRoomController>();

    // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬ í›„ userId ê°€ì ¸ì˜¤ê¸°
    userId = authController.getUserId();

    // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
    if (userId == null) {
      Future.delayed(Duration.zero, () => Get.offAllNamed('/login'));
    }
  }

  @override
  Widget build(BuildContext context) {
    // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°, ë¡œë”© í™”ë©´ì„ í‘œì‹œ (Get.offAllNamed()ê°€ ì‹¤í–‰ë  ë•Œê¹Œì§€)
    if (userId == null) {
      return const Scaffold(
        body: Center(child: CircularProgressIndicator()),
      );
    }

    return Scaffold(
      appBar: AppBar(title: const Text('Add Work Room')),
      body: Padding(
        padding: const EdgeInsets.all(20.0), // âœ… ì „ì²´ íŒ¨ë”© ì¶”ê°€
        child: Obx(() {
          if (workRoomController.isLoading.value) {
            return const Center(child: CircularProgressIndicator());
          }

          return Form(
            key: _formKey,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text("Work Room Title", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                const SizedBox(height: 8),
                TextFormField(
                  controller: _titleController,
                  decoration: InputDecoration(
                    labelText: 'Enter title',
                    contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14), // âœ… ì—¬ë°± ì¶”ê°€
                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                  ),
                  validator: (value) {
                    if (value == null || value.isEmpty) {
                      return 'Please enter a title';
                    }
                    return null;
                  },
                ),
                const SizedBox(height: 20),

                const Text("Description", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                const SizedBox(height: 8),
                TextFormField(
                  controller: _descriptionController,
                  maxLines: 3, // âœ… ì…ë ¥ ê³µê°„ í™•ëŒ€
                  decoration: InputDecoration(
                    labelText: 'Enter description',
                    contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14), // âœ… ì—¬ë°± ì¶”ê°€
                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(8)),
                  ),
                  validator: (value) {
                    if (value == null || value.isEmpty) {
                      return 'Please enter a description';
                    }
                    return null;
                  },
                ),
                const SizedBox(height: 30),

                // âœ… ë²„íŠ¼ ë””ìì¸ ê°œì„  (ë„ˆë¹„ í™•ì¥ + íŒ¨ë”© ì¶”ê°€)
                SizedBox(
                  width: double.infinity, // ë²„íŠ¼ ë„ˆë¹„ í™•ì¥
                  child: ElevatedButton(
                    onPressed: () async {
                      if (_formKey.currentState!.validate()) {
                        await workRoomController.addWorkRoom(
                          _titleController.text,
                          _descriptionController.text,
                          userId!, // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID ì‚¬ìš© (nullì´ ë  ê°€ëŠ¥ì„± ì—†ìŒ)
                        );

                        if (workRoomController.successMessage.isNotEmpty) {
                          // âœ… ì¶”ê°€ í›„ WorkRoom ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                          final listController = Get.find<WorkRoomListController>();
                          listController.fetchWorkRooms();

                          _showSuccessSnackbar(workRoomController.successMessage.value);
                          Navigator.pop(context);
                        } else if (workRoomController.errorMessage.isNotEmpty) {
                          _showErrorDialog(context, workRoomController.errorMessage.value);
                        }
                      }
                    },
                    style: ElevatedButton.styleFrom(
                      padding: const EdgeInsets.symmetric(vertical: 14), // âœ… ë²„íŠ¼ ë‚´ë¶€ íŒ¨ë”© ì¶”ê°€
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)), // âœ… ë²„íŠ¼ ë‘¥ê¸€ê¸° ì¡°ì •
                    ),
                    child: const Text('Add Work Room', style: TextStyle(fontSize: 16)),
                  ),
                ),
              ],
            ),
          );
        }),
      ),
    );
  }

  // âœ… ì„±ê³µ ì‹œ í™”ë©´ ìƒë‹¨ì— SnackBar í‘œì‹œ
  void _showSuccessSnackbar(String message) {
    Get.snackbar(
      'Success',
      message,
      snackPosition: SnackPosition.TOP,
      backgroundColor: Colors.green.withOpacity(0.8),
      colorText: Colors.white,
      duration: const Duration(seconds: 2),
    );
  }

  // âœ… ì—ëŸ¬ ë°œìƒ ì‹œ AlertDialog í‘œì‹œ
  void _showErrorDialog(BuildContext context, String errorMessage) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Error'),
        content: Text(errorMessage),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('OK'),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    _titleController.dispose();
    _descriptionController.dispose();
    super.dispose();
  }
}


// ===== FILE: ./lib/features/work_room/presentation/work_room_list_screen.dart =====

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:legalfactfinder2025/core/utils/formatters.dart';
import 'package:legalfactfinder2025/features/work_room/presentation/work_room_requests_page.dart';
import 'package:legalfactfinder2025/features/work_room/work_room_list_controller.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_model.dart';
import 'package:legalfactfinder2025/features/work_room/presentation/add_work_room_page.dart';

class WorkRoomListScreen extends StatefulWidget {
  WorkRoomListScreen({Key? key}) : super(key: key);

  @override
  _WorkRoomListScreenState createState() => _WorkRoomListScreenState();
}

class _WorkRoomListScreenState extends State<WorkRoomListScreen> {
  late WorkRoomListController controller;

  @override
  void initState() {
    super.initState();
    controller = Get.find<WorkRoomListController>();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(
        children: [
          Positioned.fill(
            child: _buildWorkRoomList(),
          ),
          // FAB ì¶”ê°€
          Positioned(
            bottom: 16.0,
            left: 16.0,
            child: FloatingActionButton(
              backgroundColor: Colors.white,
              mini: true,
              onPressed: () {
                _navigateToWorkRoomRequests(context);
              },
              child: Icon(
                Icons.mail_outline,
                color: Colors.blue,
              ),
              tooltip: "View Work Room Invitations",
            ),
          )
        ],
      ),
    );
  }

  void _navigateToWorkRoomRequests(BuildContext context) {
    Navigator.push(
      context,
      MaterialPageRoute(builder: (context) => WorkRoomRequestsPage()),
    );
  }

  // âœ… ë¡œë”© í™”ë©´
  Widget _buildLoading() {
    return const Center(child: CircularProgressIndicator());
  }

  // âœ… ì—ëŸ¬ í™”ë©´
  Widget _buildError(String errorMessage) {
    return Center(
      child: Text(
        errorMessage,
        style: const TextStyle(color: Colors.red, fontSize: 16),
      ),
    );
  }

  // âœ… Work Roomì´ ì—†ì„ ë•Œ ë¹ˆ í™”ë©´ + ë²„íŠ¼ ì¶”ê°€
  Widget _buildEmptyState() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Image.asset(
            // âœ… ìƒì„±ëœ ì´ë¯¸ì§€ ì ìš©
            'assets/images/workroom_placeholder.png',
            width: 200,
            height: 200,
          ),
          const SizedBox(height: 20),
          const Text(
            "ì•„ì§ Work Roomì´ ì—†ìŠµë‹ˆë‹¤!",
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 10),
          const Text(
            "ìƒˆë¡œìš´ Work Roomì„ ë§Œë“¤ì–´ í˜‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”.",
            textAlign: TextAlign.center,
            style: TextStyle(fontSize: 14, color: Colors.grey),
          ),
          const SizedBox(height: 20),

          // âœ… Work Room ìƒì„± ë²„íŠ¼
          SizedBox(
            width: 200,
            child: ElevatedButton(
              onPressed: () {
                Get.to(() => AddWorkRoomPage()); // Work Room ìƒì„± í˜ì´ì§€ ì´ë™
              },
              child: const Text("ë‚´ ì²« Work Room ë§Œë“¤ê¸°"),
            ),
          ),
        ],
      ),
    );
  }

  // âœ… Work Room ë¦¬ìŠ¤íŠ¸ í™”ë©´
  Widget _buildWorkRoomList() {
    return Obx(() {
      return RefreshIndicator(
        onRefresh: () async {
          await controller.fetchWorkRooms();
        },
        color: Theme.of(context).colorScheme.secondary, // âœ… App Theme ìƒ‰ìƒ ì ìš©

        child: controller.isLoading.value
            ? Container(
                color: Colors.grey[400],
                child: ListView(
                  children: const [
                    SizedBox(height: 250), // ì—¬ë°± ì¶”ê°€
                    Center(child: CircularProgressIndicator()), // ë¡œë”© í‘œì‹œ
                  ],
                ),
              )
            : controller.errorMessage.value.isNotEmpty
                ? _buildError(controller.errorMessage.value)
                : controller.workRooms.isEmpty
                    ? _buildEmptyState()
                    : Container(
                        color: Colors.black38,
                        child: ListView.separated(
                          padding: const EdgeInsets.symmetric(vertical: 0),
                          itemCount: controller.workRooms.length,
                          separatorBuilder: (context, index) =>
                              const Divider(thickness: 1, height: 1),
                          itemBuilder: (context, index) {
                            final workRoom = controller.workRooms[index];
                            return WorkRoomTile(workRoom: workRoom);
                          },
                        ),
                      ),
      );
    });
  }
}

class WorkRoomTile extends StatelessWidget {
  final WorkRoom workRoom;

  const WorkRoomTile({Key? key, required this.workRoom}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: () {
        Get.toNamed('/work_room/${workRoom.id}');
      },
      child: Container(
        color: Colors.white,
        child: Padding(
          padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Expanded(
                    child: Text(
                      workRoom.title,
                      style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 4),
              Text(
                workRoom.description,
                style: Theme.of(context).textTheme.bodyMedium,
              ),
              const SizedBox(height: 12),
              SizedBox(
                height: 40,
                child: ListView(
                  scrollDirection: Axis.horizontal,
                  children: workRoom.participants.map((participant) {
                    return Padding(
                      padding: const EdgeInsets.only(right: 8),
                      child: Chip(
                        avatar: CircleAvatar(
                          backgroundImage:
                              NetworkImage(participant.profilePictureUrl),
                        ),
                        label: Text(participant.username),
                      ),
                    );
                  }).toList(),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}


// ===== FILE: ./lib/features/work_room/presentation/work_room_page.dart =====

import 'dart:io';
import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:legalfactfinder2025/constants.dart';
import 'package:legalfactfinder2025/features/authentication/auth_controller.dart';
import 'package:legalfactfinder2025/features/chat/presentation/chat_screen.dart';
import 'package:legalfactfinder2025/features/confidentiality/presentation/signature_status_screen.dart';
import 'package:legalfactfinder2025/features/files/presentation/files_screen.dart';
import 'package:legalfactfinder2025/features/calendar/presentation/calendar_screen.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_model.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_repository.dart';
import 'package:legalfactfinder2025/features/work_room/presentation/work_room_detail_screen.dart';
import 'package:legalfactfinder2025/features/chat/presentation/thread_list_screen.dart';
import 'package:legalfactfinder2025/features/audio_record/presentation/audio_recorder_page.dart';
import 'package:legalfactfinder2025/features/work_room/presentation/work_room_request_page.dart';

class WorkRoomPage extends StatefulWidget {
  const WorkRoomPage({Key? key}) : super(key: key);

  @override
  _WorkRoomPageState createState() => _WorkRoomPageState();
}

class _WorkRoomPageState extends State<WorkRoomPage> {
  late AuthController authController;
  late WorkRoomRepository workRoomRepository;
  String? workRoomId;
  String? userId;
  WorkRoom? workRoom;
  bool isLoading = true;
  String? errorMessage;
  final bool isRoundedScreen = Platform.isIOS;

  @override
  void initState() {
    super.initState();

    authController = Get.find<AuthController>();
    workRoomRepository = WorkRoomRepository();

    userId = authController.getUserId();
    if (userId == null) {
      Future.delayed(Duration.zero, () => Get.offAllNamed('/login'));
      return;
    }

    workRoomId = Get.parameters['workRoomId'];
    if (workRoomId == null) {
      errorMessage = 'Invalid workRoomId: null';
      return;
    }

    _fetchWorkRoom();
  }

  Future<void> _fetchWorkRoom() async {
    try {
      final fetchedWorkRoom =
          await workRoomRepository.getWorkRoomById(workRoomId!);
      setState(() {
        workRoom = fetchedWorkRoom;
        isLoading = false;
      });
    } catch (e) {
      setState(() {
        errorMessage = e.toString();
        isLoading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    if (userId == null || workRoomId == null) {
      return _buildError('Invalid user or work room ID.');
    }

    if (isLoading) {
      return _buildLoading();
    }

    if (errorMessage != null) {
      return _buildError(errorMessage!);
    }

    if (workRoom == null) {
      return _buildError('Work room not found.');
    }

    return _buildWorkRoomUI(context, workRoom!);
  }

  Widget _buildLoading() {
    return const Scaffold(
      body: Center(child: CircularProgressIndicator()),
    );
  }

  Widget _buildError(String message) {
    return Scaffold(
      body: Center(
        child: Text(
          message,
          style: const TextStyle(color: Colors.red, fontSize: 16),
        ),
      ),
    );
  }

  Widget _buildWorkRoomUI(BuildContext context, WorkRoom workRoom) {
    final participantsMap = {
      for (var participant in workRoom.participants)
        participant.userId: participant.username,
    };

    return DefaultTabController(
      length: 5,
      child: Container(
        color: Colors.white, // ë…¸ì¹˜ ë° í™ˆ ì¸ë””ì¼€ì´í„° ì˜ì—­ë„ í°ìƒ‰ ì ìš©

        child: SafeArea(
          child: Scaffold(
            resizeToAvoidBottomInset: false,

            backgroundColor: Colors.white,
            appBar: AppBar(

              shadowColor: Colors.black45,
              surfaceTintColor: Colors.white,
              elevation: 1,
              title: Text(
                workRoom.title,
                style: TextStyle(fontSize: 18),
              ),
              actions: [
                GestureDetector(
                  // onTap: () => showMainLayoutBottomSheet(context),
                  child: const Padding(
                    padding: EdgeInsets.all(8.0),
                    child: Icon(
                      Icons.search,
                      size: ICON_SIZE_AT_APPBAR,
                      color: Colors.grey,
                    ),
                  ),
                ),
                GestureDetector(
                  onTap: () => _showBottomSheet(context),
                  child: const Padding(
                    padding: EdgeInsets.only(right: 24.0, left: 8, top: 8, bottom: 8),
                    child: Icon(
                      Icons.add_box,
                      size: ICON_SIZE_AT_APPBAR,
                      color: Colors.grey,
                    ),
                  ),
                ),
                // IconButton(
                //   padding: EdgeInsets.only(right: 16.0), // ì™¼ìª½ìœ¼ë¡œ 4px ì´ë™
                //
                //   icon: const Icon(
                //     Icons.add_box,
                //     color: Colors.grey,
                //     size: ICON_SIZE_AT_APPBAR,
                //   ),
                //   onPressed: () => _showBottomSheet(context),
                // ),
              ],
              bottom: const TabBar(
                labelColor: Colors.lightBlue,
                unselectedLabelColor: Colors.grey,
                indicatorColor: Colors.transparent,

                tabs: [
                  Tab(icon: Icon(Icons.chat, size: ICON_SIZE_AT_APPBAR)),
                  Tab(icon: Icon(Icons.attach_file, size: ICON_SIZE_AT_APPBAR)),
                  Tab(
                      icon: Icon(Icons.calendar_today,
                          size: ICON_SIZE_AT_APPBAR)),
                  Tab(icon: Icon(Icons.info, size: ICON_SIZE_AT_APPBAR)),
                  Tab(icon: Icon(Icons.lock, size: ICON_SIZE_AT_APPBAR)),
                ],
              ),
            ),
            body: Stack(
              children: [
                TabBarView(
                  children: [
                    ChatScreen(workRoom: workRoom, myUserId: userId!),
                    FilesScreen(workRoomId: workRoom.id),
                    CalendarScreen(),
                    WorkRoomDetailScreen(workRoom: workRoom),
                    SignatureStatusScreen(workRoomId: workRoom.id),
                  ],
                ),
                Positioned(
                  top: isRoundedScreen ? 32 : 16,
                  right: 16,
                  child: GestureDetector(
                    onTap: () {
                      showModalBottomSheet(
                        context: context,
                        isScrollControlled: true,
                        shape: const RoundedRectangleBorder(
                          borderRadius:
                              BorderRadius.vertical(top: Radius.circular(16)),
                        ),
                        builder: (context) => ThreadListScreen(
                          workRoomId: workRoom.id,
                          participantsMap: participantsMap,
                        ),
                      );
                    },
                    child: Container(
                      width: 40,
                      height: 40,
                      decoration: BoxDecoration(
                        shape: BoxShape.circle,
                        color: Colors.blue,
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withOpacity(0.2),
                            spreadRadius: 2,
                            blurRadius: 8,
                          ),
                        ],
                      ),
                      child: const Icon(Icons.view_list,
                          color: Colors.white, size: 20),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  void _showBottomSheet(BuildContext context) {
    showModalBottomSheet(
      context: context,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(16)),
      ),
      builder: (context) {
        return SafeArea(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              ListTile(
                leading: const Icon(Icons.person_add),
                title: const Text('ì¹œêµ¬ ì´ˆëŒ€'),
                onTap: () {
                  Navigator.pop(context);
                  Get.to(() => WorkRoomRequestPage(workRoomId: workRoomId!));
                },
              ),
              ListTile(
                leading: const Icon(Icons.note_add),
                title: const Text('íšŒì˜ë¡ ìƒì„±'),
                onTap: () {
                  Navigator.pop(context);
                  Get.to(() => AudioRecorderPage());
                },
              ),
            ],
          ),
        );
      },
    );
  }
}


// ===== FILE: ./lib/features/work_room/presentation/work_room_request_page.dart =====

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:legalfactfinder2025/features/work_room/work_room_request_controller.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class WorkRoomRequestPage extends StatelessWidget {
  final WorkRoomRequestController controller = Get.put(WorkRoomRequestController());
  final TextEditingController emailController = TextEditingController();
  final String workRoomId;

  WorkRoomRequestPage({super.key, required this.workRoomId});

  @override
  Widget build(BuildContext context) {
    // âœ… í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
    final requesterId = Supabase.instance.client.auth.currentUser?.id;
    if (requesterId == null) {
      return const Center(child: Text("Please log in to send work room requests."));
    }

    return Scaffold(
      appBar: AppBar(title: const Text("Send Work Room Request")),
      body: Padding(
        padding: const EdgeInsets.all(20.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const Text(
              "Enter the email address of the user you want to invite to the work room.",
              style: TextStyle(fontSize: 16),
            ),
            const SizedBox(height: 10),
            TextField(
              controller: emailController,
              keyboardType: TextInputType.emailAddress,
              decoration: const InputDecoration(
                labelText: "User Email",
                border: OutlineInputBorder(),
              ),
            ),
            const SizedBox(height: 20),

            Obx(() {
              return controller.isLoading.value
                  ? const Center(child: CircularProgressIndicator())
                  : SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: () {
                    final recipientEmail = emailController.text.trim();
                    if (recipientEmail.isEmpty) {
                      Get.snackbar("Error", "Please enter an email address.");
                      return;
                    }
                    controller.sendWorkRoomRequest(requesterId, recipientEmail, workRoomId);
                  },
                  child: const Text("Send Request"),
                ),
              );
            }),

            const SizedBox(height: 20),

            // âœ… ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            Obx(() {
              if (controller.successMessage.isNotEmpty) {
                return Text(
                  controller.successMessage.value,
                  style: const TextStyle(color: Colors.green, fontSize: 16),
                );
              }
              return const SizedBox.shrink();
            }),

            // âœ… ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            Obx(() {
              if (controller.errorMessage.isNotEmpty) {
                return Text(
                  controller.errorMessage.value,
                  style: const TextStyle(color: Colors.red, fontSize: 16),
                );
              }
              return const SizedBox.shrink();
            }),
          ],
        ),
      ),
    );
  }
}


// ===== FILE: ./lib/features/work_room/presentation/invitation_page.dart =====

import 'package:flutter/material.dart';

class InvitationPage extends StatelessWidget {
  const InvitationPage({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Invitation'),
      ),
      body: const Center(
        child: Text('Invitation Page'),
      ),
    );
  }
}


// ===== FILE: ./lib/features/work_room/presentation/work_room_requests_page.dart =====

import 'package:flutter/material.dart';
import 'package:legalfactfinder2025/features/work_room/presentation/recieved_work_room_request_list_screen.dart';
import 'package:legalfactfinder2025/features/work_room/presentation/sent_work_room_request_list_screen.dart';


class WorkRoomRequestsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return DefaultTabController(
      length: 2,
      child: Container(
        color: Colors.white,
        child: SafeArea(
          child: Scaffold(
            appBar: AppBar(
                surfaceTintColor : Colors.white,
              title: Text("Work Room Invitations"),
              bottom: TabBar(
                tabs: [
                  Tab( text: "Received"),
                  Tab( text: "Sent"),
                ],
              ),
            ),
            body: TabBarView(
              children: [
                RecievedWorkRoomRequestListScreen(),
                SentWorkRoomRequestListScreen(),
              ],
            ),
          ),
        ),
      ),
    );
  }
}


// ===== FILE: ./lib/features/work_room/presentation/sent_work_room_request_list_screen.dart =====

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:legalfactfinder2025/features/work_room/work_room_request_controller.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_request_model.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class SentWorkRoomRequestListScreen extends StatefulWidget {
  @override
  _SentWorkRoomRequestListScreenState createState() => _SentWorkRoomRequestListScreenState();
}

class _SentWorkRoomRequestListScreenState extends State<SentWorkRoomRequestListScreen> {
  final WorkRoomRequestController controller = Get.put(WorkRoomRequestController());

  @override
  void initState() {
    super.initState();

    // Ensure the API call happens after the widget is built
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final userId = Supabase.instance.client.auth.currentUser?.id;
      if (userId != null) {
        controller.fetchSentRequests(userId);
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return Obx(() {
      if (controller.isLoading.value) {
        return const Center(child: CircularProgressIndicator());
      }
      if (controller.errorMessage.isNotEmpty) {
        return Center(child: Text(controller.errorMessage.value));
      }
      if (controller.sentRequests.isEmpty) {
        return _buildEmptyState();
      }
      return ListView.builder(
        itemCount: controller.sentRequests.length,
        itemBuilder: (context, index) {
          final WorkRoomRequest request = controller.sentRequests[index];
          return ListTile(
            leading: const Icon(Icons.send, color: Colors.blue),
            title: Text("Work Room ID: \${request.workRoomId}"),
            subtitle: Text("Sent to: \${request.recipientId ?? request.recipientEmail}"),
            trailing: _buildRequestActions(request.id),
          );
        },
      );
    });
  }

  // âœ… ìš”ì²­ ì·¨ì†Œ ë²„íŠ¼
  Widget _buildRequestActions(String requestId) {
    return IconButton(
      icon: const Icon(Icons.cancel, color: Colors.red),
      onPressed: () {
        print("âŒ Canceled request: \$requestId");
        // TODO: ì´ˆëŒ€ ì·¨ì†Œ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
      },
    );
  }

  // âœ… ë³´ë‚¸ ì´ˆëŒ€ê°€ ì—†ì„ ë•Œì˜ UI
  Widget _buildEmptyState() {
    return const Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.outgoing_mail, size: 80, color: Colors.grey),
          SizedBox(height: 16),
          Text(
            "No sent work room invitations",
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          SizedBox(height: 10),
          Text(
            "You haven't sent any work room invitations yet.",
            textAlign: TextAlign.center,
            style: TextStyle(fontSize: 14, color: Colors.grey),
          ),
        ],
      ),
    );
  }
}


// ===== FILE: ./lib/features/work_room/presentation/work_room_detail_screen.dart =====

import 'package:flutter/material.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_model.dart';

class WorkRoomDetailScreen extends StatelessWidget {
  final WorkRoom workRoom;

  const WorkRoomDetailScreen({Key? key, required this.workRoom}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.all(16.0),
      child: SingleChildScrollView(
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // WorkRoom title
            Text(
              workRoom.title,
              style: Theme.of(context).textTheme.headlineMedium,
            ),
            const SizedBox(height: 8),
            // WorkRoom description
            Text(
              workRoom.description,
              style: Theme.of(context).textTheme.bodyMedium,
            ),
            const SizedBox(height: 16),
            // Participants section
            const Text(
              "Participants",
              style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 8),
            ListView.separated(
              shrinkWrap: true,
              physics: const NeverScrollableScrollPhysics(),
              itemCount: workRoom.participants.length,
              separatorBuilder: (context, index) => const Divider(),
              itemBuilder: (context, index) {
                final participant = workRoom.participants[index];
                return ParticipantTile(participant: participant);
              },
            ),
          ],
        ),
      ),
    );
  }
}

class ParticipantTile extends StatelessWidget {
  final Participant participant;

  const ParticipantTile({Key? key, required this.participant}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.center,
      children: [
        // Profile picture
        CircleAvatar(
          radius: 24,
          backgroundImage: NetworkImage(participant.profilePictureUrl),
          backgroundColor: Colors.grey[300],
        ),
        const SizedBox(width: 12),
        // Participant details
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                participant.username,
                style: const TextStyle(fontSize: 14, fontWeight: FontWeight.bold),
              ),
              const SizedBox(height: 4),
              Text(
                participant.isLawyer ? "Lawyer" : "Participant",
                style: const TextStyle(fontSize: 12, color: Colors.grey),
              ),
            ],
          ),
        ),
        // Admin Badge
        if (participant.isAdmin)
          const Text(
            "Admin",
            style: TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.bold,
              color: Colors.blue,
            ),
          ),
      ],
    );
  }
}


// ===== FILE: ./lib/features/work_room/presentation/recieved_work_room_request_list_screen.dart =====

import 'package:flutter/material.dart';
import 'package:get/get.dart';
import 'package:legalfactfinder2025/features/work_room/work_room_request_controller.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_request_model.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

class RecievedWorkRoomRequestListScreen extends StatefulWidget {
  @override
  _RecievedWorkRoomRequestListScreenState createState() => _RecievedWorkRoomRequestListScreenState();
}

class _RecievedWorkRoomRequestListScreenState extends State<RecievedWorkRoomRequestListScreen> {
  final WorkRoomRequestController controller = Get.put(WorkRoomRequestController());

  @override
  void initState() {
    super.initState();

    // Ensure the API call happens after the widget is built
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final userId = Supabase.instance.client.auth.currentUser?.id;
      if (userId != null) {
        controller.fetchReceivedRequests(userId);
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return Obx(() {
      if (controller.isLoading.value) {
        return const Center(child: CircularProgressIndicator());
      }
      if (controller.errorMessage.isNotEmpty) {
        return Center(child: Text(controller.errorMessage.value));
      }
      if (controller.receivedRequests.isEmpty) {
        return _buildEmptyState();
      }
      return ListView.builder(
        itemCount: controller.receivedRequests.length,
        itemBuilder: (context, index) {
          final WorkRoomRequest request = controller.receivedRequests[index];
          return ListTile(
            leading: const Icon(Icons.meeting_room, color: Colors.blue),
            title: Text("Work Room ID: \${request.workRoomId}"),
            subtitle: Text("Invited by: \${request.requesterId}"),
            trailing: _buildRequestActions(request.id),
          );
        },
      );
    });
  }

  // âœ… ì´ˆëŒ€ì¥ ìˆ˜ë½/ê±°ì ˆ ë²„íŠ¼
  Widget _buildRequestActions(String requestId) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        IconButton(
          icon: const Icon(Icons.check, color: Colors.green),
          onPressed: () {

              controller.handleWorkRoomRequest(requestId,  'accepted');

          },
        ),
        IconButton(
          icon: const Icon(Icons.close, color: Colors.red),
          onPressed: () {

              controller.handleWorkRoomRequest(requestId,  'declined');

          },
        ),
      ],
    );
  }

  // âœ… ë°›ì€ ì´ˆëŒ€ê°€ ì—†ì„ ë•Œì˜ UI
  Widget _buildEmptyState() {
    return const Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.mail_outline, size: 80, color: Colors.grey),
          SizedBox(height: 16),
          Text(
            "No work room invitations",
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
          ),
          SizedBox(height: 10),
          Text(
            "You haven't received any work room invitations yet.",
            textAlign: TextAlign.center,
            style: TextStyle(fontSize: 14, color: Colors.grey),
          ),
        ],
      ),
    );
  }
}


// ===== FILE: ./lib/features/work_room/work_room_controller.dart =====

import 'package:get/get.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_model.dart';
import 'package:legalfactfinder2025/features/work_room/data/work_room_repository.dart';

class WorkRoomController extends GetxController {
  final WorkRoomRepository _repository;

  // ìƒíƒœ ë³€ìˆ˜
  var workRoom = Rxn<WorkRoom>(); // Rxn: nullì„ í—ˆìš©í•˜ëŠ” ë°˜ì‘í˜• ë³€ìˆ˜
  var isLoading = false.obs; // ë¡œë”© ìƒíƒœ
  var errorMessage = ''.obs; // ì—ëŸ¬ ë©”ì‹œì§€
  var successMessage = ''.obs; // ì„±ê³µ ë©”ì‹œì§€

  WorkRoomController(this._repository);

  // WorkRoom ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  Future<void> fetchWorkRoom(String workRoomId) async {
    isLoading.value = true;
    errorMessage.value = '';
    try {
      final result = await _repository.getWorkRoomById(workRoomId);
      workRoom.value = result;
    } catch (e) {
      errorMessage.value = 'Failed to load WorkRoom: $e';
    } finally {
      isLoading.value = false;
    }
  }


  // ìƒˆë¡œìš´ WorkRoom ì¶”ê°€
  Future<void> addWorkRoom(String title, String description, String userId) async {
    isLoading.value = true;
    errorMessage.value = '';
    successMessage.value = '';
    try {
      await _repository.createWorkRoom(title, description, userId);
      successMessage.value = 'WorkRoom added successfully!';
    } catch (e) {
      errorMessage.value = 'Failed to add WorkRoom: $e';
    } finally {
      isLoading.value = false;
    }
  }
}

